<!doctype html>

<meta charset="utf-8">
<title>首页</title>
<link rel="stylesheet" href="stylesheets/jquery-ui.css">
<style>
    * {
        margin: 0;
        padding: 0;
    }
    
    #functionList {
        list-style: none;
        padding: 5px;
    }
    
    #functionList li {
        cursor: pointer;
        float: left;
        padding: 5px;
    }
    
    .clear {
        clear: both;
    }
    
    .selected {
        background: #ccc;
    }
    
    #date {
        padding: 10px;
    }
    
    #datepicker {
        margin-right: 10px;
    }
</style>
<ul id="functionList">

</ul>
<div class="clear"></div>
<div id="date">
    Date: <input type="text" id="datepicker">
    <a href="javascript:;" class="today">今日</a>
    <a href="javascript:;" class="yestoday">昨日</a>
    <a href="javascript:;" class="last7">近7日</a>
    <a href="javascript:;" class="last30">近30日</a>
    <a href="javascript:;" class="all">全部</a>
    <a href="playerInfo.html" target="_blank">玩家信息</a>
</div>
<div style="width:600px;height:300px">
    <canvas id="myChart" width="300" height="300"></canvas>
</div>
<script src="javascripts/jquery.js"></script>
<script src="javascripts/jquery-ui.js"></script>
<script src="javascripts/date.js"></script>
<script src="javascripts/Chart.js"></script>
<script>
    var currentUrl, currentBegin, currentEnd, serverStartTime;
    var ctx = document.getElementById("myChart").getContext("2d");

    $('#date').delegate('a', 'click', function(event) {
        var type = $(this).attr('class');
        switch (type) {
            case 'today':
                var today = new Date();
                currentBegin = currentEnd = formatDate(today);
                break;
            case 'yestoday':
                var today = new Date();
                currentEnd = formatDate(today);
                today.setDate(today.getDate() - 1);
                currentBegin = formatDate(today);
                break;
            case 'last7':
                var today = new Date();
                currentEnd = formatDate(today);
                today.setDate(today.getDate() - 7);
                currentBegin = formatDate(today);
                break;
            case 'last30':
                var today = new Date();
                currentEnd = formatDate(today);
                today.setDate(today.getDate() - 30);
                currentBegin = formatDate(today);
                break;
            case 'all':
                currentBegin = serverStartTime;
                var today = new Date();
                currentEnd = formatDate(today);
                break;
            default:
                break;
        }
        fetchData(ctx, currentUrl, currentBegin, currentEnd);
    });

    $.get('common/functionList', {}, function(data) {
        console.log(data);
        for (var i = 0; i < data.length; i++) {
            var aData = data[i];
            $('<li>').attr('data-url', aData.value).text(aData.label).appendTo('#functionList');
        }

        currentUrl = 'charge/totalAmount/';
        $('#functionList').find('li[data-url="' + currentUrl + '"]').addClass('selected');
        fetchData(ctx, currentUrl, currentBegin, currentEnd);
    });

    mydate.select("#datepicker", function(begin, end) {
        currentBegin = begin;
        currentEnd = end;
        fetchData(ctx, currentUrl, currentBegin, currentEnd);
    });
    $('#functionList').delegate('li', 'click', function(event) {
        $('#functionList li').removeClass('selected');
        $(this).addClass('selected');
        currentUrl = $(this).attr('data-url');
        fetchData(ctx, currentUrl, currentBegin, currentEnd);
    });

    function fetchData(ctx, url, begin, end) {
        if (!url || !begin || !end) return; //TODO 获取开服时间，作为最小begin，或者1个月前为默认end。当前时间作为最大和默认end。

        $.get(url + begin + '/' + end, {}, function(data) {
            console.log(data);
            var title = data.title;
            var data = {
                labels: data.labels,
                datasets: [{
                    label: title,
                    fillColor: "rgba(220,220,220,0.5)",
                    strokeColor: "rgba(220,220,220,1)",
                    pointColor: "rgba(220,220,220,1)",
                    pointStrokeColor: "#fff",
                    data: data.data
                }]
            }
            var config = {
                type: 'line',
                data: data,
                options: {
                    responsive: true,
                    title: {
                        display: true,
                        text: title
                    },
                    scales: {
                        xAxes: [{
                            display: true
                        }],
                        yAxes: [{
                            display: true
                        }]
                    }
                }
            };
            new Chart(ctx, config);
        });
    }

    function formatDate(date) {
        if (!date instanceof Date) return;
        return date.toLocaleDateString('zh-CN').replace(/\//g, '-');
    }

    //默认日期
    $.get('common/severStartTime', {}, function(data) {
        console.log(data);
        serverStartTime = data.serverStartTime;
        // currentBegin = serverStartTime;
        //默认取一周数据
        $('#date a.last7').click();
    });
</script>